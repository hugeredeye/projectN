# Оптимизированный запуск на macOS

## Проблема и решение

На macOS приложение работает медленно из-за особенностей виртуализации Docker и VPN. Основная проблема заключается в **дополнительном слое виртуализации**, который создается при использовании OpenVPN внутри Docker-контейнера на macOS.

Для решения этой проблемы мы **переносим VPN на хост-машину**, что значительно ускоряет работу приложения.

## Предварительная настройка (выполнить один раз)

1. **Настройте Docker Desktop для macOS**:
   - Откройте Docker Desktop
   - Перейдите в Settings → Resources
   - Увеличьте выделенную память до 4-8 ГБ
   - Увеличьте количество CPU до 4 (если доступно)
   - Нажмите Apply & Restart

2. **Настройте VPN на хост-машине**:
   ```bash
   # Запустите скрипт настройки VPN
   ./setup-host-vpn.sh
   ```
   Скрипт поможет:
   - Установить OpenVPN клиент или Tunnelblick (если не установлен)
   - Настроить VPN-соединение на вашей macOS

## Запуск приложения

### Шаг 1: Запустите VPN на хост-машине

```bash
# Вариант 1: Через Tunnelblick (если установлен)
# Запустите Tunnelblick и подключитесь к настроенному VPN

# Вариант 2: Через терминал
~/OpenVPN/start-vpn.sh
```

### Шаг 2: Запустите приложение с оптимизированной конфигурацией

```bash
# Запуск с конфигурацией для macOS
./select-docker-config.sh up
```

## Улучшения и оптимизации

Оптимизированная версия для macOS включает:

1. **VPN на хост-машине** вместо контейнера
   - Устраняет проблемы с дополнительным слоем виртуализации
   - Значительно ускоряет сетевые операции

2. **Оптимизации файловой системы**
   - Использование флага `:delegated` для всех томов
   - Кэширование ввода-вывода для улучшения производительности

3. **Оптимизация ресурсов**
   - Явное распределение памяти и CPU между контейнерами
   - Улучшенная настройка сети

## Устранение неполадок

### Если приложение все равно загружается медленно

1. Убедитесь, что VPN на хост-машине активен и работает:
   ```bash
   # Проверка статуса OpenVPN
   ps aux | grep openvpn
   ```

2. Проверьте настройки Docker Desktop:
   - Убедитесь, что выделено достаточно ресурсов
   - Проверьте, что включен экспериментальный режим для WSL2 (если используете Windows)

3. Попробуйте перезапустить Docker Desktop:
   ```bash
   # В терминале
   osascript -e 'quit app "Docker"'
   # Затем запустите Docker Desktop снова
   ```

4. Очистите кэш DNS в macOS:
   ```bash
   sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder
   ```

### Если не работает сеть внутри контейнера

Возможно, контейнер не может подключиться к VPN на хост-машине. Проверьте:

```bash
# Внутри контейнера (выполните docker exec)
ping 8.8.8.8
# или
curl --connect-timeout 5 https://api.ipify.org
```

При необходимости настройте маршрутизацию между VPN на хосте и сетью Docker. 